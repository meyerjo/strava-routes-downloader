<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <script src="https://npmcdn.com/leaflet@1.0.0-rc.2/dist/leaflet.js"></script>

    <script>
        //decode an encoded string
        function decode(encoded, mul) {
            //precision
            var inv = 1.0 / mul;
            var decoded = [];
            var previous = [0,0];
            var i = 0;
            //for each byte
            while(i < encoded.length) {
                //for each coord (lat, lon)
                var ll = [0,0]
                for(var j = 0; j < 2; j++) {
                    var shift = 0;
                    var byte = 0x20;
                    //keep decoding bytes until you have this coord
                    while(byte >= 0x20) {
                        byte = encoded.charCodeAt(i++) - 63;
                        ll[j] |= (byte & 0x1f) << shift;
                        shift += 5;
                    }
                    //add previous offset to get final value and remember for next one
                    ll[j] = previous[j] + (ll[j] & 1 ? ~(ll[j] >> 1) : (ll[j] >> 1));
                    previous[j] = ll[j];
                }
                //scale by precision and chop off long coords also flip the positions so
                //its the far more standard lon,lat instead of lat,lon
                decoded.push([ll[1] * inv,ll[0] * inv]);
            }
            //hand back the list of coordinates
            return decoded;
        }

    </script>
</head>
<body>
<div class="container">
<div id="map"></div>
    <table class="table">
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Is private</th>
            <th>Owner</th>
            <th>Favorite</th>
            <th>Distance</th>
            <th>Elevation Gain</th>
            <th>Change Time</th>
            <th>Download</th>
            <th>Download reverse</th>
        </tr>
        {% for route in routes %}
            <tr>
                <td>{{ route.name }}</td>
                <td>
                    {% if route.private %}
                        Is private
                    {% else %}
                        Is public
                    {% endif %}
                </td>
                <td>
                    {% if route.athlete.id == athlete.id %}
                        You
                    {% else %}
                        {{ route.athlete.firstname }} {{ route.athlete.lastname }}
                    {% endif %}
                </td>
                <td>{{ route.starred }}</td>
                <td>{{ route.distance|format_distance }}</td>
                <td>{{ route.elevation_gain }}</td>
                <td>{{ route.timestamp|format_datetime }}</td>
                <td><a href="{{ url_for('download_gpx', route_id = route.id) }}">Download</a></td>
                <td><a href="{{ url_for('reverse_gpx', route_id = route.id) }}">Download (reverse)</a></td>
                <td>
{#                    <button class="showmap" data-polyline="{{ route.map.summary_polyline }}" data-routeid="{{ route.id }}">Show map</button>#}

                </td>
            </tr>
            <tr>
                <td colspan="4">{{ route.description }}</td>
                <td colspan="5"></td>
            </tr>
        {% endfor %}
    </table>
</div>
<script>

            var map = L.map('map').setView([40.5, -76.5], 9);
            L.tileLayer('http://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributers'
            }).addTo(map);
    var map_buttons = document.querySelectorAll("button.showmap");
    map_buttons.forEach(function (elm) {
        elm.addEventListener('click', function (ev) {
            let dataset = this.dataset;

            let polyline = dataset['polyline'].replace(/\\\\/g, '\\')
            var decoded = decode(polyline, 1e5);
            var json = {
                type:'FeatureCollection',
                features: [{
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: decoded
                    },
                    properties: {}
                }]
            };
            geojson = L.geoJson(json,{ style: function(feature) {
                    return { fillColor: feature.properties.fill,
                        color: '#9900CC',
                        opacity: 0.75,
                        weight: 7,
                    };
                }});
            //render the geojson
            geojson.addTo(map);
            //fit it in view
            map.fitBounds(L.GeoJSON.coordsToLatLngs(decoded));
        })
    });
</script>
</body>
</html>